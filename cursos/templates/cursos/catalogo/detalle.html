{% extends 'cabezal.html' %}
{% load static %}

{% block titulo_pagina %}
    <title>{{ curso.NOMBRE_CURSO }} | ChugChillian</title>
{% endblock %}
{% block css_archivos %}
    <style>
        .curso-sidebar-sticky {
            position: sticky;
            top: 120px; /* altura de tu navbar + un poco de margen */
            z-index: 1; /* suficiente para estar encima del contenido, pero debajo del navbar si este tiene z-index alto */
        }

    </style>
{% endblock %}
{% block contenido_pagina %}

    <div class="container my-5">

        <div class="row g-5 align-items-start">

            <!-- ================== COLUMNA PRINCIPAL ================== -->
            <div class="col-lg-8">

                <h1 class="fw-bold text-brown mb-2">
                    {{ curso.NOMBRE_CURSO }}
                </h1>

                <div class="small text-muted mb-3">
                    üå± Comunidad ¬∑ ‚è≥ {{ curso.DURACION_TOTAL_CURSO }} horas ¬∑ üë• {{ curso.SUBSCRIPCION_TOTAL_CURSO }}
                    participantes
                </div>

                <p class="lead text-secondary">
                    {{ curso.DESCRIPCION_CURSO }}
                </p>

                <hr class="my-4">

                <!-- ===== CONTENIDO DEL CURSO ===== -->
                <div class="mb-4">
                    <h4 class="fw-bold text-brown">üìö Caminos de aprendizaje</h4>
                    <span class="text-muted">
                    {{ total_secciones }} rutas ¬∑ {{ total_clases }} aprendizajes
                </span>
                </div>

                {% for seccion in secciones %}
                    <div class="card border-0 shadow-sm mb-3">

                        <div class="card-header bg-light fw-semibold text-brown">
                            Ruta {{ seccion.ORDEN_SECCION_CURSO }}
                        </div>

                        <ul class="list-group list-group-flush">
                            {% for actividad in seccion.actividades.all %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">

                                    <div>
                                        üîπ {{ actividad.NOMBRE_ACTIVIDAD }}
                                    </div>

                                    <span class="badge bg-warning text-dark rounded-pill">
                                {{ actividad.DURACION_TOTAL_ACTIVIDAD }} min
                            </span>

                                </li>
                            {% endfor %}
                        </ul>

                    </div>
                {% endfor %}

                <!-- ===== REQUISITOS ===== -->
                <hr class="my-5">

                <h5 class="fw-bold text-brown">üéí Lo que necesitas traer</h5>

                <ul class="list-unstyled">
                    {% for req in requisitos %}
                        <li>‚úÖ {{ req.NOMBRE_REQUISITO }}</li>
                    {% empty %}
                        <li class="text-muted">üåæ No se requieren conocimientos previos</li>
                    {% endfor %}
                </ul>

                <!-- ===== POL√çTICAS ===== -->
                <hr>

                <h5 class="fw-bold text-brown">üõ°Ô∏è Principios del aprendizaje</h5>

                <ul class="list-unstyled">
                    {% for pol in politicas %}
                        <li>üåø {{ pol.NOMBRE_POLITICA }}</li>
                    {% empty %}
                        <li class="text-muted">No se han definido principios a√∫n</li>
                    {% endfor %}
                </ul>

            </div>


            <!-- ================== COLUMNA LATERAL ================== -->
            <div class="col-lg-4">

                <div class="card shadow border-0 p-4 rounded-4 curso-sidebar-sticky">

                    <div class="text-center mb-3">
                        <img src="{{ curso.URL_PORTADA_CURSO|default:'/static/general/images/inicio/imagen_inicio_portada.png' }}"
                             alt="{{ curso.NOMBRE_CURSO }}"
                             class="img-fluid rounded-4">
                    </div>

                    <div class="text-center mb-3">
                        <h2 class="fw-bold text-brown">
                            ${{ curso.COSTO_TOTAL_CURSO }}
                        </h2>
                        <small class="text-muted">Aporte comunitario</small>
                    </div>

{% if user.is_authenticated %}

    {% if ya_inscrito %}
        <!-- Ya est√° inscrito -->
        <button type="button"
                class="btn btn-outline-secondary w-100 fw-bold mb-3 shadow-sm"
                disabled>
            ‚úÖ Ya est√°s inscrito en este aprendizaje
        </button>

        <a href="{% url 'mi_aprendizaje' %}"
           class="btn btn-success w-100 fw-bold shadow-sm">
            üìö Ir a mi aprendizaje
        </a>

    {% else %}
        <!-- NO est√° inscrito todav√≠a: mostramos modal -->
        <button type="button"
                class="btn btn-success w-100 fw-bold mb-3 shadow-sm"
                data-bs-toggle="modal"
                data-bs-target="#modalInscripcion">
            üå± Inscribirme
        </button>
    {% endif %}

{% else %}
    <!-- No autenticado -->
    <a href="{% url 'login' %}?next={{ request.path }}"
       class="btn btn-warning w-100 fw-bold mb-3 shadow-sm">
        üîí Inicia sesi√≥n para inscribirte
    </a>
{% endif %}



                    <div class="bg-light rounded p-3 small">

                        <ul class="list-unstyled mb-0">
                            <li>üìú Certificado cultural</li>
                            <li>üìÇ Recursos vivos</li>
                            <li>üåé Comunidad activa</li>
                            <li>‚ôæ Acceso permanente</li>
                        </ul>

                    </div>

                </div>

            </div>

        </div>

    </div>

    <!-- ================== CURSOS RELACIONADOS ================== -->
    <hr class="my-5">

    <div class="container">
        <h4 class="fw-bold text-brown mb-3">üåø Otros aprendizajes que podr√≠an interesarte</h4>

        <div class="row g-4" id="contenedor-relacionados">
            <div class="text-muted">Cargando recomendaciones...</div>
        </div>
    </div>
    <div class="modal fade" id="modalInscripcion" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">

            <div class="modal-content rounded-4 shadow">

                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-brown">Confirmar inscripci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body text-center">

                    <p class="fs-6">
                        ¬øDeseas inscribirte en el curso:
                    </p>

                    <p class="fw-bold text-brown">
                        {{ curso.NOMBRE_CURSO }}
                    </p>

                    <p class="small text-muted">
                        Tendr√°s acceso completo al contenido del curso.
                    </p>

                </div>

                <div class="modal-footer border-0 d-flex justify-content-center">

                    <button type="button"
                            class="btn btn-outline-secondary rounded-pill px-4"
                            data-bs-dismiss="modal">
                        Cancelar
                    </button>

                    <a href="{% url 'inscribirse_curso' curso.id %}"
                       class="btn btn-success rounded-pill px-4">
                        ‚úÖ Confirmar inscripci√≥n
                    </a>

                </div>

            </div>

        </div>
    </div>

{% endblock %}

{% block jvscript_archivos_defer %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const cursoId = "{{ curso.pk|default:'' }}";

            fetch(`/cursos/detalle/ajax/${cursoId}`)
                .then(response => response.json())
                .then(data => {

                    const contenedor = document.getElementById("contenedor-relacionados");
                    contenedor.innerHTML = "";

                    if (!data.cursos.length) {
                        contenedor.innerHTML = "<p class='text-muted'>No hay cursos relacionados disponibles.</p>";
                        return;
                    }

                    data.cursos.forEach(curso => {

                        const card = `
                    <div class="col-md-6 col-lg-3">
                        <div class="card shadow-sm h-100 border-0 rounded-4">

                            <img src="${curso.imagen}"
                                 class="card-img-top rounded-top-4"
                                 alt="${curso.nombre}"
                                 onerror="this.src='/static/general/images/inicio/imagen_inicio_portada.png'">

                            <div class="card-body d-flex flex-column">

                                <h6 class="fw-bold text-brown">${curso.nombre}</h6>

                                <p class="small text-muted">
                                    ‚è≥ ${curso.duracion} horas
                                </p>

                                <p class="small">
                                    ${curso.descripcion}
                                </p>

                                <div class="mt-auto">
                                    <p class="fw-bold text-brown">$${curso.precio}</p>

                                    <a href="/cursos/detalle/${curso.id}/"
                                       class="btn btn-outline-success btn-sm w-100">
                                        Ver aprendizaje
                                    </a>
                                </div>

                            </div>
                        </div>
                    </div>
                `;

                        contenedor.insertAdjacentHTML("beforeend", card);
                    });

                })
                .catch(error => {
                    console.error("Error cargando cursos relacionados:", error);
                });

        });
    </script>
{% endblock %}
